# Журнал решений

## 2025-07-24 19:16 (UTC+3)

- **Решение:** Создание структуры Memory Bank
- **Обоснование:** Для сохранения контекста проекта и истории принятия решений
- **Последствия:** Упростит поддержку проекта и обеспечит преемственность разработки
- **Альтернативы:** Рассматривалось использование существующих систем документации, но решено создать специализированную систему для проекта

## 2025-07-24 19:19 (UTC+3)

- **Решение:** Детализация информации в Memory Bank
- **Обоснование:** Для улучшения понимания проекта новыми участниками и моделями ИИ
- **Последствия:** Ускорение онбординга, снижение когнитивной нагрузки при работе с кодом
- **Детали:**
    - Добавлена информация о технологическом стеке
    - Включены диаграммы потоков данных
    - Добавлены примеры реализации кода
- **Альтернативы:** Можно было ограничиться общей информацией, но детализация признана необходимой

## 2025-07-24 19:30 (UTC+3)

- **Решение:** Исправление проблемы с часовыми поясами в записи времени кормления
- **Проблема:** Время кормления записывалось в UTC вместо московского времени (UTC+3), что приводило к отображению времени на 3 часа раньше
- **Обоснование:** Пользователи находятся в московском часовом поясе и ожидают видеть корректное местное время
- **Реализация:**
    - Создана функция `getMoscowTime()` для получения времени в UTC+3
    - Обновлены методы: `createFeeding()`, `createUser()`, `setSetting()`, `createScheduledFeeding()`, `cleanupOldScheduledFeedings()`
    - Заменено использование `CURRENT_TIMESTAMP` на явную передачу московского времени
- **Последствия:** Все новые записи будут создаваться с корректным московским временем

## 2025-07-27 15:26 (UTC+3)

- **Решение:** Исправление проблемы с часовыми поясами в таймере
- **Проблема:** Время следующего кормления рассчитывалось с использованием Date.now(), который возвращает UTC время, а не московское
- **Обоснование:** Пользователи находятся в московском часовом поясе и ожидают видеть корректное местное время
- **Реализация:**
    - Добавлен импорт функции toMoscowTime в timer.ts
    - Обновлены методы restartWithNewInterval() и startFeedingTimer() для использования toMoscowTime()
- **Последствия:** Время следующего кормления теперь будет отображаться корректно в московском часовом поясе

## 2025-07-27 15:31 (UTC+3)

- **Решение:** Исправление проблемы с двойной конвертацией времени в таймере
- **Проблема:** После предыдущего исправления на удаленном сервере время следующего кормления отображалось с лишними 3 часами из-за двойной конвертации в московский часовой пояс
- **Обоснование:** Необходимо, чтобы время следующего кормления сохранялось в UTC, а конвертация в московский часовой пояс происходила только при отображении
- **Реализация:**
    - В методах restartWithNewInterval() и startFeedingTimer() в timer.ts убрано применение toMoscowTime() при расчете времени следующего кормления
    - Время следующего кормления теперь сохраняется в локальном часовом поясе сервера (который может быть в UTC)
    - При отображении времени в bot.ts и других местах применяется toMoscowTime() для конвертации в московский часовой пояс
- **Последствия:** Время следующего кормления теперь будет отображаться корректно как на локальном компьютере, так и на удаленном сервере

## 2025-07-27 16:04 (UTC+3)

- **Решение:** Удаление дублирующей функции getOrCreateUser из schedule-feeding.ts
- **Проблема:** В проекте было несколько дублирующих функций getOrCreateUser, что увеличивало размер кода и создавало потенциальные проблемы с поддержкой
- **Обоснование:** Необходимо использовать единую функцию getOrCreateUser из main.ts во всех сценах для обеспечения консистентности и упрощения поддержки
- **Реализация:**
    - В schedule-feeding.ts удалена дублирующая функция getOrCreateUser
    - Добавлен импорт getOrCreateUser из ./main
    - Теперь schedule-feeding.ts использует ту же функцию, что и другие сцены
- **Последствия:** Уменьшен размер кода, улучшена консистентность, упрощена поддержка

## 2025-07-27 16:15 (UTC+3)

- **Решение:** Исправление отображения времени следующего кормления в main.ts
- **Проблема:** Время следующего кормления отображалось без конвертации в московский часовой пояс, что приводило к неправильному времени
- **Обоснование:** Необходимо, чтобы все отображаемые времена были в московском часовом поясе для корректного восприятия пользователями
- **Реализация:**
    - В строке 92 файла main.ts добавлено применение toMoscowTime() при отображении времени следующего кормления
    - В строке 187 файла main.ts добавлено применение toMoscowTime() при отображении времени следующего кормления
- **Последствия:** Время следующего кормления теперь отображается корректно в московском часовом поясе
